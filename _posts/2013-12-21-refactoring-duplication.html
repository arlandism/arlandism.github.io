---
layout: article
title: Refactoring "Duplication"
date: '2013-12-21T15:51:00.001-08:00'
author: aml
tags: 
modified_time: '2013-12-21T15:51:57.994-08:00'
blogger_id: tag:blogger.com,1999:blog-1730093662423317857.post-4106260640654466562
blogger_orig_url: https://immutablearlandis.blogspot.com/2013/12/refactoring-duplication.html
---

I hadn't gotten around to implementing the refactor I mentioned in this post, but Wai Lee and I finally got to pair on it yesterday. The refactor was<span style="font-family: Times, Times New Roman, serif;"> fun and well worth the effort, since it cleaned up a lot of <a href="http://immutablearlandis.blogspot.com/2013/12/duplication.html" target="_blank">duplication</a> and reduced the spread of knowledge in the system.</span><br /><span style="font-family: Times, Times New Roman, serif;"><br /></span><span style="font-family: Times, Times New Roman, serif;">As a refresher, the code looked something like this:</span><br /><span style="font-family: Times, Times New Roman, serif;"><br /></span><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">"</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">(if (api-manager/should-hit-api? lookup-key timeout)</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; (do</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; &nbsp; (let [new-response (hit-api)]</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; &nbsp; &nbsp; (cache-new-response new-response)</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new-response))</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; (api-manager/last-response-for lookup-key))</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">"</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;"><br /></span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">The desired functionality of this pattern was to query an API if a certain length of time had gone by, and to retrieve the cached response otherwise. The api-manager namespace records the responses and makes the decision of whether or not the right amount of time has elapsed based on the last time it was updated.</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;"><br /></span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">It sucked putting these exact same lines of code everywhere, so Wai Lee and I simplified the pattern to look like this:</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;"><br /></span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">"</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">(defn fetch-or-fallback [lookup-key fallback-strategy timeout]</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; (if (api-manager/should-hit-api? lookup-key timeout)</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; (do</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; &nbsp; (let [new-response (fallback-strategy)]</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(cache-new-response new-response)</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new-response))</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">&nbsp; &nbsp; &nbsp; (api-manager/last-response-for lookup-key)))</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">"</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;"><br /></span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">We called it "fetch-or-fallback" because it's pretty similar to Ruby's fetch.</span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;"><br /></span></div><div style="background-color: white; color: #333333; line-height: 19px; margin: 0px; outline: none; padding: 0px; text-align: justify;"><span style="font-family: Times, Times New Roman, serif;">After refactoring to this new implementation, we moved the "fetch-or-fallback" function into the api-manager namespace, allowing us to make "should-hit-api?" and "last-response-for" private.</span></div>
